# Patient Facts – Output Generation

Using the tabular output generated by `pf_process`, this function will
build a graph to visualize the results. Each function configuration will
output a bespoke ggplot. Theming can be adjusted by the user after the
graph has been output using `+ theme()`. Most graphs can also be made
interactive using `make_interactive_squba()`

## Usage

``` r
pf_output(
  process_output,
  output = NULL,
  date_breaks_str = "1 year",
  domain_filter = NULL,
  visit_filter = NULL,
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- process_output:

  *tabular input* \|\| **required**

  The tabular output produced by `pf_process`

  Note any patient-level results generated are not intended to be used
  with this function.

- output:

  *string* \|\| defaults to `NULL`

  The name of the numerical variable from `process_output` that should
  be used to generate the plot. This input is required for the following
  checks:

  - `Single Site, Exploratory, Cross-Sectional`

  - `Multi-Site, Exploratory, Cross-Sectional`

  - `Single Site, Anomaly Detection, Cross-Sectional`

  - `Single Site, Exploratory Longitudinal`

  - `Multi Site Exploratory Longitudinal`

- date_breaks_str:

  *string* \|\| defaults to `1 year`

  A string that controls the time period division on the x-axis ('1
  year', '3 months', etc). This parameter is only required for the
  `Single Site, Exploratory, Longitudinal` check.

- domain_filter:

  *string* \|\| defaults to `NULL`

  A string indicating the domain of interest for plotting. This
  parameter is required for the following checks:

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi-Site, Anomaly Detection, Longitudinal`

- visit_filter:

  *string* \|\| defaults to `NULL`

  A string indicating the visit type of interest for plotting. This
  parameter is required for the following checks:

  - `Multi-Site, Anomaly Detection, Cross-Sectional`

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi-Site, Anomaly Detection, Longitudinal`

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information.

## Value

This function will produce a graph to visualize the results from
`pf_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'patientfacts'))

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'pf_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA

## turn of SQL trace for example
config('db_trace', FALSE)

#' Build mock study cohort
cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000), # RSQLite does not store date objects,
                                      # hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Execute `pf_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
pf_process_example <- pf_process(cohort = cohort,
                                 study_name = 'example_study',
                                 multi_or_single_site = 'single',
                                 anomaly_or_exploratory = 'exploratory',
                                 visit_type_table =
                                   patientfacts::pf_visit_file_omop,
                                 omop_or_pcornet = 'omop',
                                 visit_types = c('all'),
                                 domain_tbl = patientfacts::pf_domain_file %>%
                                   dplyr::filter(domain == 'diagnoses')) %>%
  suppressMessages()
#> ┌ Output Function Details ─────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying    │
#> │ `pf_output` function. Here are the parameters you will need: │
#> │                                                              │
#> │ Always Required: process_output                              │
#> │ Required for Check: output                                   │
#> │                                                              │
#> │ See ?pf_output for more details.                             │
#> └──────────────────────────────────────────────────────────────┘

pf_process_example
#> # A tibble: 1 × 11
#>   study     site  visit_type domain median_all_with0s median_all_without0s n_tot
#>   <chr>     <chr> <chr>      <chr>              <dbl>                <dbl> <dbl>
#> 1 example_… comb… all        diagn…                 0                    0    12
#> # ℹ 4 more variables: n_w_fact <dbl>, median_site_with0s <dbl>,
#> #   median_site_without0s <dbl>, output_function <chr>

#' Execute `pf_output` function
#' The output was edited for a better indication of what the visualization will
#' look like.
#' The 0s are a limitation of the small sample data set used for this example
pf_output_example <- pf_output(process_output = pf_process_example %>%
                                 dplyr::mutate(median_site_without0s = 4),
                                 ## tweak synthetic output for example
                               output = 'median_site_without0s')

pf_output_example


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(pf_output_example)

{"x":{"data":[{"orientation":"h","width":0.89999999999999991,"base":0,"x":[4],"y":[1],"text":"domain: diagnoses<br />median_site_without0s: 4<br />domain: diagnoses","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(255,77,111,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"name":"diagnoses","legendgroup":"diagnoses","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":34.995433789954348,"r":7.3059360730593621,"b":37.260273972602747,"l":78.173515981735179},"paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.20000000000000001,4.2000000000000002],"tickmode":"array","ticktext":["0","1","2","3","4"],"tickvals":[0,1,2,3,4],"categoryorder":"array","categoryarray":["0","1","2","3","4"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Median Facts / Follow-Up for Patients with Fact","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178088},{"text":"Domain","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-62.831050228310502},{"text":"all","x":0.5,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.40000000000000002,1.6000000000000001],"tickmode":"array","ticktext":["diagnoses"],"tickvals":[1],"categoryorder":"array","categoryarray":["diagnoses"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"showlegend":true,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498},"title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"1a4ab1ca2c":{"x":{},"y":{},"fill":{},"type":"bar"}},"cur_data":"1a4ab1ca2c","visdat":{"1a4ab1ca2c":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}
```
